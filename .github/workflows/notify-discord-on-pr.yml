name: Notify Discord on PR

on:
  pull_request:
    branches:
      - main
      - server/dev
    types: [opened, synchronize]

jobs:
  notify-discord:
    runs-on: ubuntu-latest
    steps:
      - name: PR ìƒì„± ì•Œë¦¼ (opened)
        if: github.event.action == 'opened'
        uses: tsickert/discord-webhook@v7.0.0
        with:
          webhook-url: ${{ secrets.DISCORD_WEBHOOK_URL }}
          content: |
            ## ğŸ› ï¸ Pull Request ì•Œë¦¼
            **ì œëª©**: ${{ github.event.pull_request.title }}
            **ì‘ì„±ì**: `${{ github.actor }}`
            **URL**: <${{ github.event.pull_request.html_url }}>
            ## ğŸ“ ë¦¬ë·° ìš”ì²­
            `${{ github.event.pull_request.body || 'ë¦¬ë·° ë¶€íƒë“œë¦½ë‹ˆë‹¤!' }}`

      - name: ì»¤ë°‹ ë©”ì‹œì§€ ê°€ì ¸ì˜¤ê¸° (synchronize)
        if: github.event.action == 'synchronize'
        id: get_commits
        run: |
          echo "ğŸ” PR ì»¤ë°‹ ë©”ì‹œì§€ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤..."
          commits=$(curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            "${{ github.event.pull_request.commits_url }}" || echo "[]")
          messages=$(echo "$commits" | jq -r '.[].commit.message' 2>/dev/null | sed ':a;N;$!ba;s/\n/\\n- /g')
          if [ -z "$messages" ]; then
            messages="(â—ì»¤ë°‹ ë©”ì‹œì§€ë¥¼ ê°€ì ¸ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.)"
          else
            messages="- ${messages}"
          fi
          echo "commits<<EOF" >> $GITHUB_OUTPUT
          echo "$messages" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: PR ì—…ë°ì´íŠ¸ ì•Œë¦¼ (synchronize)
        if: github.event.action == 'synchronize'
        run: |
            curl -X POST -H "Content-Type: application/json" \
              -d @- "${{ secrets.DISCORD_WEBHOOK_URL }}" <<EOF
          {
         "content": "**ğŸ”„ Pull Requestê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤!**\\n**ì œëª©**: ${{ github.event.pull_request.title }}\\n**ì‘ì„±ì**: ${{ github.actor }}\\n**URL**: <${{ github.event.pull_request.html_url }}>\\n**ğŸ“¦ ë³€ê²½ ì‚¬í•­ ì»¤ë°‹:**\\n${{ steps.get_commits.outputs.commits }}\\nğŸ‘‰ ë³€ê²½ëœ ë‚´ìš©ì„ ë‹¤ì‹œ í™•ì¸í•´ì£¼ì„¸ìš”!"
          }
          EOF